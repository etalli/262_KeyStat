# KeyLens

[English](README.md) | 日本語

macOS メニューバー常駐型のキーストローク・マウスクリック監視・記録アプリです。
キー／ボタンごとの入力回数を集計し、JSON ファイルに保存します。1,000 回押すごとに macOS 通知を送信します。

---

## 機能

- **グローバル監視**: アクティブなアプリに関係なく、すべてのキー入力とマウスクリックをカウント
- **マウスクリック計測**: 左・右・中ボタンおよびサイドボタンを個別にカウント
- **メニューバー統計**: キーボードアイコンをクリックすると本日のカウント・累計・平均入力間隔・最小入力間隔（最速バースト）・Top 10 を表示
- **全件表示**: すべてのキー・マウスボタンを累計／本日別にランキング表示するウィンドウを開く
- **グラフ表示**: 4種類のインタラクティブなグラフ — Top 20 キー（横棒、種別カラー）、日別合計（折れ線）、キー分類（ドーナツ）、日別 Top 10（グループ棒グラフ）
- **CSV 書き出し**: 全データを 2 つの CSV ファイルに書き出し — サマリー（キーごとの累計）と日別明細 — 保存先フォルダを指定して保存
- **データをコピー**: `counts.json` をカスタマイズ可能な AI プロンプト付きでクリップボードにコピー — そのまま AI アシスタントに貼り付けて分析できる
- **AI プロンプト編集**: **設定… → AI プロンプトを編集…** でプロンプト文を編集。言語（英語／日本語）ごとに独立して保存
- **キーオーバーレイ**: 画面左下に半透明のフローティングウィンドウをリアルタイム表示。修飾キーの組み合わせを ⌘C / ⇧A 形式で表示。3 秒間入力がないとフェードアウト。メニューからトグル
- **本日のカウント**: 日別集計、深夜0時に自動リセット
- **データ保存**: 再起動後もカウントを保持（JSON ファイルに保存）
- **マイルストーン通知**: キー／ボタンごとに 1,000 回ごとにネイティブ通知（1000, 2000, …）
- **多言語 UI**: English / 日本語 / システム自動検出
- **権限復帰の即時対応**: アクセシビリティ権限付与後、自動でモニタリングを再開

---

## 動作環境

| 項目 | 要件 |
|------|------|
| macOS | 13 Ventura 以降 |
| Swift | 5.9 以降（Xcode 15 付属） |
| 権限 | アクセシビリティ（初回起動時にプロンプト表示） |

---

## ビルド

```bash
# App Bundle のみ作成
./build.sh

# ビルド後にそのまま起動（プロジェクトフォルダから実行）
./build.sh --run

# ビルド → /Applications にインストール → codesign → TCC リセット → 起動  ← 推奨
./build.sh --install

# 配布用 DMG を作成（ユーザーが /Applications にドラッグ）
./build.sh --dmg
```

> `swift build` 単体でも実行ファイルは生成されますが、通知機能には App Bundle が必要です。必ず `build.sh` を使用してください。

### ビルドスクリプトの動作

```
swift build -c release
  └─ .build/release/KeyLens   （実行ファイル）

KeyLens.app/
  ├── Contents/MacOS/KeyLens   <- 実行ファイルをここにコピー
  └── Contents/Info.plist         <- LSUIElement=true でDockに非表示
```

### `--install` の手順（開発時推奨）

| ステップ | 内容 |
|----------|------|
| `cp -r KeyLens.app /Applications/` | `/Applications` にインストール |
| `codesign --force --deep --sign -` | ad-hoc 署名（アクセシビリティ権限を安定化） |
| `pkill -x KeyLens` | 旧プロセスを停止してからバイナリを差し替え |
| `tccutil reset Accessibility <bundle-id>` | 古いバイナリハッシュの TCC エントリを削除 |
| `open /Applications/KeyLens.app` | 新しいビルドを起動 |

**TCC リセットが必要な理由:** macOS はアクセシビリティ権限をバイナリのハッシュ単位で管理しています。`swift build` のたびに新しいバイナリ（異なるハッシュ）が生成されるため、古い TCC エントリが陳腐化します。リセットしないと、システム設定でトグルが ON になっていても `AXIsProcessTrusted()` が `false` を返し続けます。

### ログ確認

```bash
tail -f ~/Library/Logs/KeyLens/app.log
```

---

## アクセシビリティ権限

権限がない場合、初回起動時にアラートが表示されます。

1. **「システム設定を開く」** をクリック
2. **プライバシーとセキュリティ → アクセシビリティ** に移動
3. **KeyLens** を有効化
4. 任意のアプリに戻る — モニタリングが即座に再開

**権限復帰の仕組み（多段構成）:**

| トリガー | 復帰までの時間 |
|----------|---------------|
| アプリがアクティブになる（`didBecomeActiveNotification`） | ほぼ即時 |
| 権限リトライタイマー | 3 秒ごと |
| ヘルスチェックタイマー | 5 秒ごと |

---

## セキュリティ

### このアプリが記録すること・しないこと

| | 詳細 |
|---|---|
| **記録する** | キー名（例: `Space`, `e`）・マウスボタン名（例: `🖱Left`）と押下回数のみ |
| **記録しない** | 入力テキスト・文字列・パスワード・クリップボードの内容・マウスカーソルの位置 |
| **保存先** | ローカル JSON ファイルのみ — ネットワーク送信なし |
| **イベントアクセス** | `.listenOnly` タップ — 読み取り専用、キー入力の改ざん・注入は不可 |

### リスク一覧

| 項目 | リスク | 本アプリでの対策 |
|------|--------|----------------|
| グローバルキー監視 | 高（権限の性質上） | `.listenOnly` + `tailAppendEventTap` — 受動的リッスンのみ |
| データの内容 | 低 | キー名＋カウントのみ。入力文字列の再構築は不可能 |
| データファイル | 中 | 無暗号化。同一ユーザーの他プロセスが読める |
| ネットワーク | なし | 外部通信は一切なし |
| プロセス実行 | 低 | `/usr/bin/open` を固定パスでのみ実行 |
| コード署名 | 中 | ad-hoc のみ。他ユーザーへの配布は Gatekeeper がブロック |

### アクセシビリティ権限が必要な理由

macOS はグローバル `CGEventTap` のインストールにユーザーの明示的な同意（システム設定 → プライバシーとセキュリティ → アクセシビリティ）を要求します。この権限がなければ `AXIsProcessTrusted()` が `false` を返し、タップは生成されません。これは macOS が強制するゲートであり、ユーザーが許可しない限りキー入力の監視は行われません。

### 配布する場合

現在は ad-hoc 署名（`codesign --sign -`）を使用しており、個人利用では十分です。他のユーザーへ配布するには：

- **Apple Developer Program** に加入（年額 $99）
- **Developer ID Application** 証明書で署名
- **Apple 公証（Notarisation）** を申請（macOS 10.15 以降で Gatekeeper 通過に必須）

---

## データファイル

```
~/Library/Application Support/KeyLens/counts.json
```

```json
{
  "startedAt": "2026-01-01T00:00:00Z",
  "counts": {
    "Space": 15234,
    "Return": 8901,
    "e": 7432
  },
  "dailyCounts": {
    "2026-02-22": 3120
  }
}
```

メニューの **設定… → 保存先を開く** でフォルダを Finder で開けます。


---

内部設計の詳細は [Architecture.ja.md](Architecture.ja.md) を参照してください。
