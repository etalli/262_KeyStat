# KeyLens 理解度確認テスト：解答と解説

## 第1部：基本構成とアーキテクチャ

**Q1. KeyLens のアーキテクチャは大きく3つのレイヤーで構成されています。それらは何ですか？**
- **正解：** イベント監視 (Event Monitoring)、データ管理 (Data Management)、UI 制御 (UI Control)
- **解説：** [Architecture.md](file:///Users/k2/Library/CloudStorage/Dropbox/MyProjects/262_KeyLens/Architecture.md) の冒頭に定義されています。OSレベルの入力を監視し、ストアがデータを集計・保存し、メニューやウィンドウがそれを表示するという明確な役割分担がなされています。

**Q2. アプリケーションの起動時、`main.swift` で設定されている「Dock にアイコンを表示せず、メニューバーアプリとして動作させるための設定」は何ですか？**
- **正解：** `app.setActivationPolicy(.accessory)`
- **解説：** これにより、通常のアプリのように Dock にアイコンが出たり、メニューバーがそのアプリのものに切り替わったりするのを防ぎ、常駐型ツールとしての挙動を実現しています。

**Q3. キー入力イベントを OS レベルでキャッチするために使用されている技術（API）は何ですか？**
- **正解：** `CGEventTap` (Core Graphics Framework)
- **解説：** macOS の低レベル API である `CGEventTap` を使用することで、アプリが背後にある状態でもシステム全体のキーボード入力を取得できます。

---

## 第2部：実装の詳細と設計判断

**Q4. [KeyboardMonitor.swift](file:///Users/k2/Library/CloudStorage/Dropbox/MyProjects/262_KeyLens/Sources/KeyLens/KeyboardMonitor.swift) の `inputTapCallback` は、なぜクラスのメソッドではなく「グローバル関数」として定義されているのでしょうか？**
- **正解：** `CGEvent.tapCreate` が要求するコールバック引数が、C 言語互換の関数ポインタ (`@convention(c)`) である必要があるため。
- **解説：** Swift のインスタンスメソッド（クラス内の関数）は、暗黙的に `self` をキャプチャするため、C 言語の関数ポインタとして渡すことができません。グローバル関数にすることでキャプチャを排除し、C API との互換性を確保しています。

**Q5. `KeyCountStore` はシングルトンとして実装されていますが、スレッドセーフをどのように実現していますか？**
- **正解：** 専用のシリアルキュー (`DispatchQueue(label: "com.keycounter.store")`) を使用した排他制御。
- **解説：** キー入力イベントはメインスレッド以外で発生しますが、UI（メニュー）からの読み取りはメインスレッドで行われます。`queue.sync` を使って辞書へのアクセスを一箇所に並べることで、クラッシュやデータ破損を防いでいます。

**Q6. DISK への書き込み頻度を抑えるためにどのような工夫をしていますか？**
- **正解：** デバウンス (Debouncing) 処理。`DispatchWorkItem` のキャンセルと `asyncAfter(deadline: .now() + 2.0)` を組み合わせている。
- **解説：** キーが押されるたびに保存するのではなく、最後の入力から 2 秒間入力がなかったときだけ保存処理を走らせることで、ディスク I/O を劇的に減らしています。

---

## 第3部：データとUI

**Q7. 累計のキー入力回数などのデータは、Mac のどのディレクトリに保存されますか？**
- **正解：** `~/Library/Application Support/KeyLens/counts.json`
- **解説：** Mac の標準的なアプリケーションデータ保存場所である `Application Support` 内に専用フォルダを作って保存しています。

**Q8. メニューバーのメニューはどのタイミングで更新されますか？**
- **正解：** B) ユーザーがメニューをクリックして開こうとした瞬間に更新される
- **解説：** `NSMenuDelegate` の `menuWillOpen` を利用しています。キー入力のたびに UI を更新するのは重いため、必要な時（表示される直前）だけ集計データからメニューを作り直しています。

**Q9. キー入力が一定数に達したときに通知を出す処理は、どのクラスが担当していますか？**
- **正解：** `NotificationManager`
- **解説：** `KeyCountStore` が「キリの良い数字」を検知し、`NotificationManager` がユーザーに通知を出すという連携が行われています。

---

## 第4部：応用

**Q10. `KeyType.swift` は何のために存在し、どのように活用されていますか？**
- **正解：** キーの種類（文字、数字、矢印、制御キーなど）を分類し、色やラベルを定義するため。
- **解説：** 主にチャート画面で「どの種類のキーをよく使っているか」を色分けして視覚的に分かりやすく表示するために使われています。
